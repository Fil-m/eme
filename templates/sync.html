{% extends "base.html" %}

{% block content %}

<h2 style="font-size: 2.5rem; margin-bottom: 2rem; font-weight: 900;">{{ t('sync_title') }}</h2>

<div class="sync-grid" style="display: grid; grid-template-columns: 350px 1fr; gap: 2.5rem; align-items: flex-start;">
    <div class="card" style="text-align: center; border-color: var(--primary); padding: 2.5rem;">
        <h3 style="margin-top: 0; font-size: 1.25rem;">{{ t('sync_my_addr') }}</h3>
        <code
            style="display: block; background: rgba(0,0,0,0.4); padding: 1rem; font-size: 1rem; color: var(--accent-aqua); margin: 1.5rem 0; border-radius: 12px; border: 1px solid var(--border); overflow-x: auto;">{{ my_address }}</code>

        <div
            style="background: white; padding: 1rem; border-radius: 16px; display: inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <img src="/qr?text={{ quote(my_address) }}" width="200" height="200" style="display: block;">
        </div>
        <p class="meta" style="margin-top: 1.5rem; font-weight: 600;">{{ t('sync_scan_qr') }}</p>
    </div>

    <div style="display: flex; flex-direction: column; gap: 2.5rem;">
        {% if msg %}
        <div class="card"
            style="background: rgba(34, 211, 238, 0.1); border: 1px solid var(--accent-aqua); color: var(--accent-aqua); font-weight: 600; padding: 1.5rem;">
            âš¡ {{ msg }}
        </div>
        {% endif %}

        <form method="POST" class="card" style="padding: 2.5rem;">
            <h3 style="margin-top: 0; margin-bottom: 1.5rem;">{{ t('sync_pull_title') }}</h3>
            <p class="meta" style="margin-bottom: 1.5rem;">{{ t('sync_enter_addr') }}</p>

            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <input type="text" id="peer_address" name="peer_address" placeholder="http://192.168..." required
                    style="flex: 1; margin-bottom: 0; font-size: 1.1rem;">
                <button type="button" class="btn btn-secondary" id="start-scan"
                    style="padding: 0 1.5rem; height: 50px;">ðŸ“· {{ t('scan_btn') }}</button>
            </div>

            <div id="reader"
                style="width: 100%; display: none; margin-bottom: 1.5rem; border-radius: 16px; overflow: hidden; border: 2px solid var(--primary);">
            </div>
            <p id="scan-error" style="color: var(--primary); display: none; margin-bottom: 1.5rem; font-weight: 600;">
            </p>

            <button type="submit" class="btn"
                style="width: 100%; justify-content: center; font-size: 1.1rem; padding: 1rem;">{{ t('sync_btn')
                }}</button>
        </form>

        <div class="card" style="padding: 2.5rem;">
            <h3 style="margin-top: 0; color: var(--accent-purple);">{{ t('sync_how_title') }}</h3>
            <p class="meta" style="font-size: 1.05rem;">{{ t('sync_how_desc') }}</p>
        </div>
    </div>
</div>

<style>
    @media (max-width: 900px) {
        .sync-grid {
            grid-template-columns: 1fr !important;
        }
    }
</style>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    let html5QrScanner = null;

    document.getElementById('start-scan').addEventListener('click', function () {
        const reader = document.getElementById('reader');
        const errorMsg = document.getElementById('scan-error');

        if (reader.style.display === 'none') {
            reader.style.display = 'block';
            errorMsg.style.display = 'none';

            if (!html5QrScanner) {
                html5QrScanner = new Html5Qrcode("reader");
            }

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrScanner.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    document.getElementById('peer_address').value = decodedText;
                    html5QrScanner.stop();
                    reader.style.display = 'none';
                },
                (errorMessage) => {
                    // console.warn(errorMessage);
                }
            ).catch(err => {
                errorMsg.innerText = "Camera error: " + err + ". Note: HTTPS or localhost is required for camera.";
                errorMsg.style.display = 'block';
                reader.style.display = 'none';
            });
        } else {
            if (html5QrScanner) {
                html5QrScanner.stop();
            }
            reader.style.display = 'none';
        }
    });
</script>

{% endblock %}